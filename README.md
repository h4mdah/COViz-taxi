**COViz-taxi**

A toolbox for generating and visualizing counterfactual / contrastive outcomes for Taxi environment agents.

**Overview**
- **Purpose:** run and analyze contrastive/counterfactual comparisons for Taxi agents (supports SB3-trained agents via adapter), extract Q-values (best-effort), produce visualizations (side-by-side GIFs) and stylized re-renders of Taxi states.
- **Main components:** trace generation, contrastive scoring/highlight selection, visualization tools.

**Quick status**
- Visualization tools are available at `tools/side_by_side_gifs.py` and `tools/render_side_by_side_env.py` (stylized renderer based on Taxi integer state).
- SB3 agent fallback wrapping is implemented in `counterfactual_outcomes/interfaces/Taxi/taxi_interface.py` (best-effort Q-value extraction and adapter logic).
- Known issues: environment synchronization (making env1 and env2 start from identical internal state) can be fragile in some wrapper configurations; Gym vs Gymnasium differences may produce warnings.

**Repository Layout (key files)**
- `run.py` — top-level runner (project entrypoints vary by task).
- `counterfactual_outcomes/` — main pipeline:
  - `common.py` — Trace/State classes and utilities.
  - `train_model.py`, `main.py`, `contrastive_online.py`, `contrastive_online_RD.py` — contrastive pipeline and training helpers.
  - `interfaces/Taxi/` — Taxi-specific adapters and environment wrappers (`taxi_interface.py`, `environments.py`).
- `traces/` — example saved traces; e.g. `traces/taxi/Traces.pkl`.
- `results/` — run outputs (Traces.pkl, Selected_Highlights.pkl, results directories, generated GIFs).
- `tools/` — visualization and helper scripts added during iteration:
  - `tools/side_by_side_gifs.py` — compose GIFs from stored `State.image` frames in traces.
  - `tools/render_side_by_side_env.py` — re-render Taxi integer states by setting `env.unwrapped.s` and calling `env.render()`; falls back to `custom_render_from_state()` which draws a stylized map (hedges, road, taxi, passenger, building).
  - `tools/inspect_selected_run.py`, `tools/inspect_traces_run.py`, `tools/check_all_traces.py` — small inspectors for pickles.
  - `tools/list_outputs.py` — list generated GIFs folder contents.

**Data formats and expectations**
- `Traces.pkl` typically contains a `list` of Trace objects. Each Trace exposes a `states` list of `State` objects. A `State` usually contains:
  - `state` : integer Taxi internal state
  - `image` or `img` : optional RGB frame (PIL Image or numpy array)
- `Selected_Highlights.pkl` used by visualization is a `list` of items commonly shaped like `((trace_idx, contrastive_idx), score_array)`. Visualization tools accept this format and also fall back to pairing traces with themselves if `selected` is missing.

**Pipeline (step-by-step)**
1. Agent: train or load an agent (SB3 or rl_agents).
   - When an SB3 `.zip` model is available, the Taxi adapter in `counterfactual_outcomes/interfaces/Taxi/taxi_interface.py` attempts to load it and expose the interfaces expected by the contrastive pipeline. Q-value extraction from SB3 DQN is best-effort and may require model-specific adjustments.

2. Trace generation: run training or evaluation to produce pickled `Traces.pkl` files containing Trace objects with `states` and optional `image` frames.

3. Contrastive selection: run the contrastive pipeline (`counterfactual_outcomes/contrastive_online.py` or `main.py`) to produce `Selected_Highlights.pkl`, a list of candidate (original, contrastive) pairs with scores.

4. Visualization: generate side-by-side animations using one of two approaches:
   - `tools/side_by_side_gifs.py` — builds animations using frames stored inside Trace/State objects.
   - `tools/render_side_by_side_env.py` — re-renders frames by setting the Taxi environment's internal integer state and calling `env.render()`; falls back to `custom_render_from_state()` when native rendering is unavailable.

**Commands (Windows/cmd) — common tasks**
- Regenerate stylized GIFs (example):

```cmd
conda activate coviz
python tools\render_side_by_side_env.py --traces "results\run_2025-11-18_12-20-50_2132\Traces.pkl" --selected "results\run_2025-11-18_12-20-50_2132\Selected_HighLights.pkl" --out-dir "results\side_by_side_env_regen" --fps 3 --max 6
```

- Generate GIFs from stored frame images (if `State.image` exists):

```cmd
python tools\side_by_side_gifs.py --traces traces\taxi\Traces.pkl --selected results\Selected_Highlights.pkl --out-dir results\side_by_side_sample --fps 3
```

- Inspect selected highlights structure:

```cmd
python tools\inspect_selected_run.py results\run_2025-11-18_12-20-50_2132\Selected_Highlights.pkl
```

- List outputs generated by previous run:

```cmd
python tools\list_outputs.py
```

**Changes made during iteration**
- `tools/render_side_by_side_env.py` — stylized renderer with fallback rendering logic and convenience features:
  - maps out-of-range contrastive indices into available `Traces.pkl` entries (modulo mapping)
  - samples frames to at most 60 per GIF to keep output sizes manageable
- `tools/side_by_side_gifs.py` — composition script for traces containing images.
- `tools/inspect_selected_run.py`, `tools/inspect_traces_run.py`, `tools/check_all_traces.py`, `tools/list_outputs.py` — inspection utilities.

**Behavioral details & notes**
- `Selected_Highlights.pkl` format: entries are often `((trace_idx, contrastive_idx), score_array)`; visualization scripts expect the first element to contain a 2-tuple with trace and contrastive indices.
- Out-of-range indices: when `Selected_Highlights` references indices larger than the run-specific `Traces.pkl`, the renderer maps the contrastive index into the locally-available `Traces.pkl` via modulo and logs the mapping.
- Gym vs Gymnasium: the code imports `gym`. For compatibility with newer NumPy versions and render modes, replace `import gym` with `import gymnasium as gym` if required.
- Environment synchronization: wrappers may hide the inner environment; to synchronize internal state across two env instances, set `unwrapped.s` on the correct inner object after identifying wrapper chains.

**Troubleshooting**
- If `pickle.load` fails with `ModuleNotFoundError` for `counterfactual_outcomes` when loading `Traces.pkl`, ensure the repository root is on `PYTHONPATH` or run scripts from the repo root. Example (Windows/cmd):

```cmd
set PYTHONPATH=%CD%
python tools\inspect_traces_run.py traces\taxi\Traces.pkl
```

- If GIF generation stalls during palette conversion (Pillow), reduce frame count by lowering `--max` or adjusting `max_frames` in `tools/render_side_by_side_env.py`.

**Available next actions**
- Re-run the renderer against `traces/taxi/Traces.pkl` so contrastive indices map directly.
- Refine the stylized renderer (colors, cell size, labels) and re-generate GIFs.
- Attach a base64-encoded GIF for sharing.
- Instrument `counterfactual_outcomes/interfaces/Taxi/taxi_interface.py` to stabilize environment synchronization.

**Where outputs are located**
- Check `results/` for run outputs and generated GIFs. Example:
  - `results\side_by_side_env_regen\t9_c170.gif`
  - `results\side_by_side_env_regen\t9_c177.gif`
  - `results\side_by_side_env_regen\t9_c184.gif`
  - `results\side_by_side_env_regen\t9_c191.gif`
  - `results\side_by_side_env_regen\t9_c198.gif`

**References**
- Implementation follows ideas from "Explaining Reinforcement Learning Agents Through Counterfactual Action Outcomes" (AAAI-24).
- External tools/repositories used: `rl-agents` (https://github.com/eleurent/rl-agents).
